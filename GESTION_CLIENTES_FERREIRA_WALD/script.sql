CREATE SCHEMA GESTIONCLIENTE;
USE GESTIONCLIENTE;

SET SQL_SAFE_UPDATES = 0;

CREATE TABLE TABLAS (
  TABLA VARCHAR(50) NOT NULL PRIMARY KEY,
  USA_NUMERADOR BOOLEAN NOT NULL
);

CREATE TABLE EMPRESA (
  ID_EMPRESA INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
  EMP_NOMBRE VARCHAR(100) NOT NULL,
  RUT VARCHAR(30) NOT NULL
);

CREATE TABLE NUMERADOR (
  ID_EMPRESA INT NOT NULL,
  ENTIDAD VARCHAR(50) NOT NULL,
  ULTIMO_NUM INT NOT NULL,
  PRIMARY KEY (ID_EMPRESA,ENTIDAD),
  CONSTRAINT FK_NUM_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA)
);

CREATE TABLE ESTADO (
  ID_ESTADO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
  ENTIDAD VARCHAR(50) NOT NULL,
  DESCRIPCION VARCHAR(50) NOT NULL
);

CREATE TABLE PRODUCTO (
  ID_EMPRESA INT NOT NULL,
  ID_PRODUCTO INT NOT NULL,
  PRD_NOMBRE VARCHAR(100) NOT NULL,
  IS_ACTIVO BOOLEAN NOT NULL DEFAULT 0,
  PRIMARY KEY (ID_EMPRESA,ID_PRODUCTO),
  CONSTRAINT FK_PRODUCTO_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA)
);

CREATE TABLE POLITICA (
  ID_EMPRESA INT NOT NULL,
  ID_POLITICA INT NOT NULL,
  POL_NOMBRE VARCHAR(100) NOT NULL,
  POL_PRECIO DECIMAL(10,2) NOT NULL,
  IS_ACTIVO BOOLEAN NOT NULL DEFAULT 0,
  PRIMARY KEY (ID_EMPRESA,ID_POLITICA),
  CONSTRAINT FK_POLITICA_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA)
);

CREATE TABLE PRODUCTOPOL (
  ID_EMPRESA INT NOT NULL,
  ID_PRODUCTO INT NOT NULL,
  ID_POLITICA INT NOT NULL,
  PRIMARY KEY (ID_EMPRESA,ID_PRODUCTO,ID_POLITICA),
  CONSTRAINT FK_PRODUCTOPOL_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA),
  CONSTRAINT FK_PRODUCTOPOL_PRODUCTO FOREIGN KEY (ID_EMPRESA,ID_PRODUCTO) REFERENCES PRODUCTO (ID_EMPRESA,ID_PRODUCTO),
  CONSTRAINT FK_PRODUCTOPOL_POLITICA FOREIGN KEY (ID_EMPRESA,ID_POLITICA) REFERENCES POLITICA (ID_EMPRESA,ID_POLITICA)
);

CREATE TABLE CLIENTE (
  ID_EMPRESA INT NOT NULL,
  ID_CLIENTE INT NOT NULL,
  CLI_NOMBRE VARCHAR(100) NOT NULL,
  CLI_APELLIDO VARCHAR(100) NOT NULL,
  DNI VARCHAR(30) NOT NULL,
  EMAIL VARCHAR(100),
  ID_ESTADO INT NOT NULL,
  CLI_TELEFONO VARCHAR(20),
  DIRECCION VARCHAR(100) NOT NULL,
  PRIMARY KEY (ID_EMPRESA,ID_CLIENTE),
  CONSTRAINT FK_CLIENTE_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA),
  CONSTRAINT FK_CLIENTE_ESTADO FOREIGN KEY (ID_ESTADO) REFERENCES ESTADO (ID_ESTADO)
);

CREATE INDEX IX_CLIENTE_DNI ON CLIENTE (DNI);
CREATE INDEX IX_CLIENTE_EMAIL ON CLIENTE (EMAIL);
CREATE INDEX IX_CLIENTE_ESTADO ON CLIENTE (ID_EMPRESA,ID_ESTADO);

CREATE TABLE CONTRATO (
  ID_EMPRESA INT NOT NULL,
  ID_CONTRATO INT NOT NULL,
  ID_PRODUCTO INT NOT NULL,
  ID_POLITICA INT NOT NULL,
  ID_CLIENTE INT NOT NULL,
  ID_ESTADO INT NOT NULL,
  FCH_CONTRATO DATE NOT NULL,
  FCH_VIGENCIA DATE,
  FCH_FIN DATE,
  PRIMARY KEY (ID_EMPRESA,ID_CONTRATO),
  CONSTRAINT FK_CONTRATO_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA),
  CONSTRAINT FK_CONTRATO_PRODUCTO FOREIGN KEY (ID_EMPRESA,ID_PRODUCTO) REFERENCES PRODUCTO (ID_EMPRESA,ID_PRODUCTO),
  CONSTRAINT FK_CONTRATO_POLITICA FOREIGN KEY (ID_EMPRESA,ID_POLITICA) REFERENCES POLITICA (ID_EMPRESA,ID_POLITICA),
  CONSTRAINT FK_CONTRATO_CLIENTE FOREIGN KEY (ID_EMPRESA,ID_CLIENTE) REFERENCES CLIENTE (ID_EMPRESA,ID_CLIENTE),
  CONSTRAINT FK_CONTRATO_ESTADO FOREIGN KEY (ID_ESTADO) REFERENCES ESTADO (ID_ESTADO)
);

CREATE INDEX IX_CONTRATO_CLIENTE ON CONTRATO (ID_EMPRESA,ID_CLIENTE);
CREATE INDEX IX_CONTRATO_ESTADO ON CONTRATO (ID_EMPRESA,ID_ESTADO);
CREATE INDEX IX_CONTRATO_PRODUCTO ON CONTRATO (ID_EMPRESA,ID_PRODUCTO);
CREATE INDEX IX_CONTRATO_VIGENCIA ON CONTRATO (ID_EMPRESA,FCH_VIGENCIA,FCH_FIN);

CREATE TABLE FACTURA (
  ID_EMPRESA INT NOT NULL,
  ID_FACTURA INT NOT NULL,
  ID_CLIENTE INT NOT NULL,
  IS_PAGA BOOLEAN NOT NULL DEFAULT(0),
  FAC_FCH DATE NOT NULL,
  FAC_TOTAL DECIMAL(10,2) NOT NULL,
  FAC_FCH_PAGO DATE,
  FACTURA_ULT_LIN INT DEFAULT 0,
  PRIMARY KEY (ID_EMPRESA,ID_FACTURA),
  CONSTRAINT FK_FACTURA_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA),
  CONSTRAINT FK_FACTURA_CLIENTE FOREIGN KEY (ID_EMPRESA,ID_CLIENTE) REFERENCES CLIENTE (ID_EMPRESA,ID_CLIENTE)
);

CREATE INDEX IX_FACTURA_CLIENTE ON FACTURA (ID_EMPRESA,ID_CLIENTE);
CREATE INDEX IX_FACTURA_FECHA ON FACTURA (ID_EMPRESA,FAC_FCH);
CREATE INDEX IX_FACTURA_PAGO ON FACTURA (ID_EMPRESA, FAC_FCH_PAGO);

CREATE TABLE FACTURALINEA (
  ID_EMPRESA INT NOT NULL,
  ID_FACTURA INT NOT NULL,
  ID_FACTURALIN INT NOT NULL,
  ID_CONTRATO INT NOT NULL,
  FAC_LIN_IMP DECIMAL(10,2) NOT NULL,
  PRIMARY KEY (ID_EMPRESA,ID_FACTURA,ID_FACTURALIN),
  CONSTRAINT FK_FACTURALIN_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA),
  CONSTRAINT FK_FACTURALIN_FACTURA FOREIGN KEY (ID_EMPRESA,ID_FACTURA) REFERENCES FACTURA (ID_EMPRESA,ID_FACTURA),
  CONSTRAINT FK_FACTURALIN_CONTRATO FOREIGN KEY (ID_EMPRESA,ID_CONTRATO) REFERENCES CONTRATO (ID_EMPRESA,ID_CONTRATO)
);

CREATE TABLE ORDENTIPO (
  ID_ORDENTPO VARCHAR(1) NOT NULL PRIMARY KEY,
  DESCRIPCION VARCHAR(30) NOT NULL
);

CREATE TABLE ORDENSERVICIO (
  ID_EMPRESA INT NOT NULL,
  ID_ORDEN INT NOT NULL,
  ID_CONTRATO INT NOT NULL,
  ID_ORDENTPO VARCHAR(1) NOT NULL,
  ORD_FCH DATE NOT NULL,
  ORD_FCH_FIN DATE,
  ID_ESTADO INT NOT NULL,
  PRIMARY KEY (ID_EMPRESA,ID_ORDEN),
  CONSTRAINT FK_ORDENSRV_EMPRESA FOREIGN KEY (ID_EMPRESA) REFERENCES EMPRESA (ID_EMPRESA),
  CONSTRAINT FK_ORDENSRV_CONTRATO FOREIGN KEY (ID_EMPRESA,ID_CONTRATO) REFERENCES CONTRATO (ID_EMPRESA,ID_CONTRATO),
  CONSTRAINT FK_ORDENSRV_ORDENTPO FOREIGN KEY (ID_ORDENTPO) REFERENCES ORDENTIPO (ID_ORDENTPO),
  CONSTRAINT FK_ORDENSRV_ESTADO FOREIGN KEY (ID_ESTADO) REFERENCES ESTADO (ID_ESTADO)
);

CREATE INDEX IX_ORDENSRV_CONTRATO ON ORDENSERVICIO (ID_EMPRESA,ID_CONTRATO);
CREATE INDEX IX_ORDENSRV_ESTADO ON ORDENSERVICIO (ID_EMPRESA,ID_ESTADO);
CREATE INDEX IX_ORDENSRV_FECHA ON ORDENSERVICIO (ID_EMPRESA,ORD_FCH);

DELIMITER $$
CREATE TRIGGER TR_INICIALIZAR_NUMERADORES
AFTER INSERT ON EMPRESA
FOR EACH ROW
BEGIN
	INSERT INTO NUMERADOR (ID_EMPRESA,ENTIDAD,ULTIMO_NUM)
		SELECT NEW.ID_EMPRESA,TABLA,0 FROM TABLAS
        WHERE USA_NUMERADOR = TRUE;
END $$
DELIMITER ;

INSERT INTO TABLAS (TABLA,USA_NUMERADOR) VALUES 
	('EMPRESA', 0),
    ('PRODUCTO', 1),
    ('POLITICA', 1),
    ('PRODUCTOPOL', 0),
    ('CLIENTE', 1),
    ('CONTRATO', 1),
    ('FACTURA', 1),
    ('FACTURALINEA', 0),
    ('ORDENSERVICIO', 1);

INSERT INTO EMPRESA (EMP_NOMBRE,RUT) VALUES
	('FitLife Gym S.R.L.', '21.200.001-1'),
	('SegurAlarm S.A.', '21.200.002-0'),
	('CloudHost Uruguay S.R.L.', '21.200.003-9'),
	('PureWater Delivery S.A.', '21.200.004-7'),
	('PetCare Plan S.R.L.', '21.200.005-5'),
	('GreenHome Jardinería S.A.', '21.200.006-3'),
	('SmartEnergy S.R.L.', '21.200.007-1'),
	('EduPro E-Learning S.A.', '21.200.008-0'),
	('CaféClub Suscripciones S.R.L.', '21.200.009-8'),
	('DriveNow Rent S.A.', '21.200.010-6');
    
INSERT INTO ESTADO (ENTIDAD,DESCRIPCION) VALUES
	('CLIENTE', 'INGRESADO'),
	('CLIENTE', 'CONECTADO'),
	('CLIENTE', 'DESCONECTADO'),
	('CLIENTE', 'ANULADO'),
	('CONTRATO', 'INGRESADO'),
	('CONTRATO', 'CONECTADO'),
	('CONTRATO', 'DESCONECTADO'),
	('CONTRATO', 'ANULADO'),
	('ORDENSERVICIO', 'INGRESADA'),
	('ORDENSERVICIO', 'FINALIZADA'),
	('ORDENSERVICIO', 'CANCELADA');

INSERT INTO ORDENTIPO (ID_ORDENTPO,DESCRIPCION) VALUES
	('I', 'INSTALACION'),
	('D', 'DESCONEXION'),
	('R', 'RECLAMO');

/*DEVUELVE EL ID DEL ESTADO POR SU DESCRIPCION*/
DELIMITER $$
CREATE FUNCTION FN_BUSCAR_ESTADO(F_ENTIDAD VARCHAR(50), F_ESTADO VARCHAR(50))
RETURNS INT
DETERMINISTIC
BEGIN
	DECLARE F_ID_ESTADO INT;
    SELECT ID_ESTADO INTO F_ID_ESTADO
    FROM ESTADO
    WHERE ENTIDAD = F_ENTIDAD
    AND DESCRIPCION = F_ESTADO;
    RETURN F_ID_ESTADO;
END $$
DELIMITER ;

/*DEVUELVE EL PROXIMO ID PARA SER USADO DE LA ENTIDAD PARA LA EMPRESA QUE SE LE ENVIA*/
DELIMITER $$
CREATE FUNCTION FN_NEW_ID(F_EMPRESA INT, F_ENTIDAD VARCHAR(50))
RETURNS INT
DETERMINISTIC
BEGIN
	DECLARE NEW_ID INT;
    SELECT ULTIMO_NUM + 1 INTO NEW_ID
    FROM NUMERADOR
    WHERE ENTIDAD = F_ENTIDAD
    AND ID_EMPRESA = F_EMPRESA;
    RETURN NEW_ID;
END $$
DELIMITER ;

/*INGRESO DE PRODUCTO*/
DELIMITER $$
CREATE PROCEDURE SP_INS_PRODUCTO(P_EMPRESA INT, P_NOMBRE VARCHAR(100), P_ACTIVO BOOLEAN)
BEGIN
	DECLARE P_ID_PRODUCTO INT;
    SELECT FN_NEW_ID(P_EMPRESA,'PRODUCTO') INTO P_ID_PRODUCTO;
    INSERT INTO PRODUCTO (ID_EMPRESA,ID_PRODUCTO,PRD_NOMBRE,IS_ACTIVO) VALUES (P_EMPRESA,P_ID_PRODUCTO,P_NOMBRE,P_ACTIVO);
END $$
DELIMITER ;

/*TRIGGER PARA MANTENER EL NUMERADOR CON EL MAXIMO VALOR QUE SE INGRESO A LA TABLA (ES PARA EVITAR CONFLICTOS CON INSERTS MANUALES)*/
DELIMITER $$
CREATE TRIGGER TR_UPD_NUM_PRODUCTO
AFTER INSERT ON PRODUCTO
FOR EACH ROW
BEGIN
	UPDATE NUMERADOR SET ULTIMO_NUM = (SELECT MAX(ID_PRODUCTO) FROM PRODUCTO WHERE ID_EMPRESA = NEW.ID_EMPRESA)
    WHERE ID_EMPRESA = NEW.ID_EMPRESA 
    AND ENTIDAD = 'PRODUCTO';
END $$
DELIMITER ;

/*INGRESO DE POLITICA*/
DELIMITER $$
CREATE PROCEDURE SP_INS_POLITICA(P_EMPRESA INT, P_NOMBRE VARCHAR(100), P_PRECIO DECIMAL(10,2), P_ACTIVO BOOLEAN)
BEGIN
	DECLARE P_ID_POLITICA INT;
    SELECT FN_NEW_ID(P_EMPRESA,'POLITICA') INTO P_ID_POLITICA;
    INSERT INTO POLITICA (ID_EMPRESA,ID_POLITICA,POL_NOMBRE,POL_PRECIO,IS_ACTIVO) VALUES (P_EMPRESA,P_ID_POLITICA,P_NOMBRE,P_PRECIO,P_ACTIVO);
END $$
DELIMITER ;

/*TRIGGER PARA MANTENER EL NUMERADOR CON EL MAXIMO VALOR QUE SE INGRESO A LA TABLA (ES PARA EVITAR CONFLICTOS CON INSERTS MANUALES)*/
DELIMITER $$
CREATE TRIGGER TR_UPD_NUM_POLITICA
AFTER INSERT ON POLITICA
FOR EACH ROW
BEGIN
	UPDATE NUMERADOR SET ULTIMO_NUM = (SELECT MAX(ID_POLITICA) FROM POLITICA WHERE ID_EMPRESA = NEW.ID_EMPRESA)
    WHERE ID_EMPRESA = NEW.ID_EMPRESA 
    AND ENTIDAD = 'POLITICA';
END $$
DELIMITER ;

/*INGRESO DE DATOS DE PRODUCTOS*/
INSERT INTO PRODUCTO (ID_EMPRESA, ID_PRODUCTO, PRD_NOMBRE, IS_ACTIVO) VALUES
	-- FitLife Gym
	(1, 1, 'Acceso Gimnasio 24/7', 1),
	(1, 2, 'Clases Grupales Presenciales', 1),
	-- SegurAlarm
	(2, 1, 'Sistema de Alarma Residencial', 1),
	(2, 2, 'Sistema de Cámaras IP', 1),
	-- CloudHost Uruguay
	(3, 1, 'Hosting Web Compartido', 1),
	(3, 2, 'Backup Cloud Empresarial', 1),
	-- PureWater Delivery
	(4, 1, 'Entrega de Agua Purificada 20L', 1),
	(4, 2, 'Dispensador de Agua en Comodato', 1),
	-- PetCare Plan
	(5, 1, 'Atención Veterinaria Domiciliaria', 1),
	(5, 2, 'Servicio de Paseo de Mascotas', 1),
	-- GreenHome Jardinería
	(6, 1, 'Mantenimiento de Césped', 1),
	(6, 2, 'Poda y Control de Plantas', 1),
	-- SmartEnergy
	(7, 1, 'Monitoreo de Paneles Solares', 1),
	(7, 2, 'Consultoría de Eficiencia Energética', 1),
	-- EduPro E-Learning
	(8, 1, 'Plataforma de Cursos Online', 1),
	(8, 2, 'Certificaciones Profesionales', 1),
	-- CaféClub Suscripciones
	(9, 1, 'Suscripción Café Molido', 1),
	(9, 2, 'Suscripción Café en Grano', 1),
	-- DriveNow Rent
	(10, 1, 'Alquiler Mensual de Autos', 1),
	(10, 2, 'Alquiler Mensual de Motos', 1);


/*INGRESO DE DATOS DE POLITICAS*/
INSERT INTO POLITICA (ID_EMPRESA, ID_POLITICA, POL_NOMBRE, POL_PRECIO, IS_ACTIVO) VALUES
	-- FitLife Gym
	(1, 1, 'Plan Básico Mensual', 1800.00, 1),
	(1, 2, 'Plan Premium Mensual', 3200.00, 1),
	(1, 3, 'Plan Clases Semanales', 1200.00, 1),
	(1, 4, 'Plan Clases Mensuales', 4000.00, 1),
	-- SegurAlarm
	(2, 1, 'Monitoreo Residencial Básico', 1500.00, 1),
	(2, 2, 'Monitoreo Integral de Cámaras', 2700.00, 1),
	-- CloudHost Uruguay
	(3, 1, 'Hosting Plan Starter', 800.00, 1),
	(3, 2, 'Hosting Plan Business', 1600.00, 1),
	-- PureWater Delivery
	(4, 1, 'Suscripción Hogar por Litro', 600.00, 1),
	(4, 2, 'Suscripción Oficina por Litro', 1100.00, 1),
	(4, 3, 'Suscripción Mensual Dispensador ', 1600.00, 1),
	-- PetCare Plan
	(5, 1, 'Plan Mascota Esencial', 1200.00, 1),
	(5, 2, 'Plan Mascota Full', 2100.00, 1),
	(5, 3, 'Plan Paseo Semanal', 600.00, 1),
	(5, 4, 'Plan Paseo Mensual', 1600.00, 1),
	-- GreenHome Jardinería
	(6, 1, 'Servicio Básico Mensual', 1000.00, 1),
	(6, 2, 'Servicio Integral Premium', 1800.00, 1),
	-- SmartEnergy
	(7, 1, 'Monitoreo Estándar', 900.00, 1),
	(7, 2, 'Monitoreo Avanzado + Reportes', 1600.00, 1),
	-- EduPro E-Learning
	(8, 1, 'Suscripción Individual', 750.00, 1),
	(8, 2, 'Suscripción Corporativa', 2800.00, 1),
	(8, 3, 'Certificacion Individual', 1500.00, 1),
	(8, 4, 'Certificacion Corporativa', 6000.00, 1),
	-- CaféClub Suscripciones
	(9, 1, 'Suscripción Clásica', 650.00, 1),
	(9, 2, 'Suscripción Gourmet', 1150.00, 1),
	-- DriveNow Rent
	(10, 1, 'Alquiler Estándar', 12000.00, 1),
	(10, 2, 'Alquiler Full Service', 18500.00, 1);

/*INSERT PARA VINCULAR PRODUCTOS CON POLITICAS*/
INSERT INTO PRODUCTOPOL (ID_EMPRESA, ID_PRODUCTO, ID_POLITICA) VALUES
	-- FitLife Gym
	(1, 1, 1),
	(1, 1, 2),
	(1, 2, 3),
	(1, 2, 4),
	-- SegurAlarm
	(2, 1, 1),
	(2, 2, 2),
	-- CloudHost Uruguay
	(3, 1, 1),
	(3, 2, 2),
	-- PureWater Delivery
	(4, 1, 1),
	(4, 1, 2),
	(4, 2, 3),
	-- PetCare Plan
	(5, 1, 1),
	(5, 1, 2),
	(5, 2, 3),
	(5, 2, 4),
	-- GreenHome Jardinería
	(6, 1, 1),
	(6, 2, 2),
	-- SmartEnergy
	(7, 1, 1),
	(7, 2, 2),
	-- EduPro E-Learning
	(8, 1, 1),
	(8, 1, 2),
	(8, 2, 3),
	(8, 2, 4),
	-- CaféClub Suscripciones
	(9, 1, 1),
	(9, 1, 2),
	(9, 2, 1),
	(9, 2, 2),
	-- DriveNow Rent
	(10, 1, 1),
	(10, 1, 2),
	(10, 2, 1),
	(10, 2, 2);

/*INGRESO DE NUEVO CLIENTE*/
DELIMITER $$
CREATE PROCEDURE SP_INS_CLIENTE(P_EMPRESA INT, P_NOMBRE VARCHAR(100), P_APELLIDO VARCHAR(100), P_DNI VARCHAR(30), P_EMAIL VARCHAR(100), P_STS VARCHAR(50), P_TEL VARCHAR(20), P_DIR VARCHAR(100))
BEGIN
	DECLARE P_ID_CLIENTE INT;
    DECLARE P_ESTADO INT;
    SELECT FN_NEW_ID(P_EMPRESA,'CLIENTE') INTO P_ID_CLIENTE;
    SELECT FN_BUSCAR_ESTADO('CLIENTE',P_STS) INTO P_ESTADO;
    INSERT INTO CLIENTE (ID_EMPRESA,ID_CLIENTE,CLI_NOMBRE,CLI_APELLIDO,DNI,EMAIL,ID_ESTADO,CLI_TELEFONO,DIRECCION) 
    VALUES (P_EMPRESA,P_ID_CLIENTE,P_NOMBRE,P_APELLIDO,P_DNI,P_EMAIL,P_ESTADO,P_TEL,P_DIR);
END $$
DELIMITER ;

/*TRIGGER PARA MANTENER EL NUMERADOR CON EL MAXIMO VALOR QUE SE INGRESO A LA TABLA (ES PARA EVITAR CONFLICTOS CON INSERTS MANUALES)*/
DELIMITER $$
CREATE TRIGGER TR_UPD_NUM_CLIENTE
AFTER INSERT ON CLIENTE
FOR EACH ROW
BEGIN
	UPDATE NUMERADOR SET ULTIMO_NUM = (SELECT MAX(ID_CLIENTE) FROM CLIENTE WHERE ID_EMPRESA = NEW.ID_EMPRESA)
    WHERE ID_EMPRESA = NEW.ID_EMPRESA 
    AND ENTIDAD = 'CLIENTE';
END $$
DELIMITER ;

INSERT INTO CLIENTE (ID_EMPRESA, ID_CLIENTE, CLI_NOMBRE, CLI_APELLIDO, DNI, EMAIL, ID_ESTADO, CLI_TELEFONO, DIRECCION) VALUES
	-- FitLife Gym
	(1, 1, 'Lucas', 'Fernández', '4.567.890-1', 'lucas.fernandez@fitlife.com', 1, '099123456', 'Av. Rivera 1020'),
	(1, 2, 'María', 'Pérez', '5.678.901-2', 'maria.perez@fitlife.com', 2, '098234567', 'Calle Colón 450'),
	(1, 3, 'Diego', 'López', '6.789.012-3', 'diego.lopez@fitlife.com', 3, '097345678', 'Av. Italia 1200'),
	(1, 4, 'Ana', 'Martínez', '7.890.123-4', 'ana.martinez@fitlife.com', 4, '096456789', 'Bvar. Artigas 890'),
	-- SegurAlarm
	(2, 1, 'Federico', 'Sosa', '3.456.789-0', 'federico.sosa@seguralarm.com', 1, '099223344', 'Av. Agraciada 200'),
	(2, 2, 'Sofía', 'Acosta', '2.345.678-9', 'sofia.acosta@seguralarm.com', 2, '098334455', 'Millán 3500'),
	(2, 3, 'Joaquín', 'Gómez', '1.234.567-8', 'joaquin.gomez@seguralarm.com', 3, '097445566', 'Av. Italia 5200'),
	(2, 4, 'Lucía', 'Rodríguez', '8.901.234-5', 'lucia.rodriguez@seguralarm.com', 4, '096556677', '8 de Octubre 1122'),
	-- CloudHost Uruguay
	(3, 1, 'Gonzalo', 'Pereira', '9.012.345-6', 'gonzalo.pereira@cloudhost.com', 1, '099112233', 'Av. Libertador 2500'),
	(3, 2, 'Valentina', 'Silva', '4.321.098-7', 'valentina.silva@cloudhost.com', 2, '098223344', 'Yaguarón 1450'),
	(3, 3, 'Andrés', 'Morales', '3.210.987-6', 'andres.morales@cloudhost.com', 3, '097334455', 'Rbla. Gandhi 310'),
	(3, 4, 'Camila', 'Torres', '2.109.876-5', 'camila.torres@cloudhost.com', 4, '096445566', 'Canelones 920'),
	-- PureWater Delivery
	(4, 1, 'Martín', 'Cabrera', '1.098.765-4', 'martin.cabrera@purewater.com', 1, '099556677', 'Bvar. España 222'),
	(4, 2, 'Florencia', 'Romero', '0.987.654-3', 'florencia.romero@purewater.com', 2, '098667788', 'Luis A. de Herrera 1800'),
	(4, 3, 'Sebastián', 'Álvarez', '9.876.543-2', 'sebastian.alvarez@purewater.com', 3, '097778899', 'Av. Italia 4000'),
	(4, 4, 'Paula', 'Méndez', '8.765.432-1', 'paula.mendez@purewater.com', 4, '096889900', 'Maldonado 1560'),
	-- PetCare Plan
	(5, 1, 'Nicolás', 'Ramos', '7.654.321-0', 'nicolas.ramos@petcare.com', 1, '099990011', 'Millán 4500'),
	(5, 2, 'Verónica', 'Fernández', '6.543.210-9', 'veronica.fernandez@petcare.com', 2, '098001122', 'Bvar. Artigas 2600'),
	(5, 3, 'Pablo', 'Vega', '5.432.109-8', 'pablo.vega@petcare.com', 3, '097112233', '18 de Julio 900'),
	(5, 4, 'Laura', 'Giménez', '4.321.098-7', 'laura.gimenez@petcare.com', 4, '096223344', 'Rivera 1780'),
	-- GreenHome Jardinería
	(6, 1, 'Tomás', 'Correa', '3.210.987-6', 'tomas.correa@greenhome.com', 1, '099334455', 'Arenal Grande 2400'),
	(6, 2, 'Agustina', 'López', '2.109.876-5', 'agustina.lopez@greenhome.com', 2, '098445566', 'Rbla. Francia 1320'),
	(6, 3, 'Santiago', 'Pintos', '1.098.765-4', 'santiago.pintos@greenhome.com', 3, '097556677', 'Rondeau 850'),
	(6, 4, 'Daniela', 'Rodríguez', '0.987.654-3', 'daniela.rodriguez@greenhome.com', 4, '096667788', 'Ejido 1250'),
	-- SmartEnergy
	(7, 1, 'Rodrigo', 'Martínez', '9.876.543-2', 'rodrigo.martinez@smartenergy.com', 1, '099778899', 'Colonia 340'),
	(7, 2, 'Cecilia', 'Suárez', '8.765.432-1', 'cecilia.suarez@smartenergy.com', 2, '098889900', 'Rbla. Armenia 1550'),
	(7, 3, 'Facundo', 'Núñez', '7.654.321-0', 'facundo.nunez@smartenergy.com', 3, '097990011', 'Canelones 2100'),
	(7, 4, 'Julieta', 'García', '6.543.210-9', 'julieta.garcia@smartenergy.com', 4, '096001122', 'Guayabos 1450'),
	-- EduPro E-Learning
	(8, 1, 'Mauricio', 'Díaz', '5.432.109-8', 'mauricio.diaz@edupro.com', 1, '099112244', 'Durazno 1234'),
	(8, 2, 'Antonella', 'Reyes', '4.321.098-7', 'antonella.reyes@edupro.com', 2, '098223355', 'Colonia 2100'),
	(8, 3, 'Gabriel', 'Silveira', '3.210.987-6', 'gabriel.silveira@edupro.com', 3, '097334466', 'Gonzalo Ramírez 800'),
	(8, 4, 'Martina', 'Campos', '2.109.876-5', 'martina.campos@edupro.com', 4, '096445577', 'Soriano 950'),
	-- CaféClub Suscripciones
	(9, 1, 'Ezequiel', 'Rivas', '1.098.765-4', 'ezequiel.rivas@cafeclub.com', 1, '099556688', 'Palmar 1256'),
	(9, 2, 'Clara', 'Mora', '0.987.654-3', 'clara.mora@cafeclub.com', 2, '098667799', 'Mercedes 2345'),
	(9, 3, 'Ignacio', 'Pérez', '9.876.543-2', 'ignacio.perez@cafeclub.com', 3, '097778800', 'Jackson 1820'),
	(9, 4, 'Sabrina', 'López', '8.765.432-1', 'sabrina.lopez@cafeclub.com', 4, '096889911', 'Rbla. República Argentina 430'),
	-- DriveNow Rent
	(10, 1, 'Bruno', 'Aguilar', '7.654.321-0', 'bruno.aguilar@drivenow.com', 1, '099990022', 'Luis A. de Herrera 2500'),
	(10, 2, 'Carolina', 'Ortiz', '6.543.210-9', 'carolina.ortiz@drivenow.com', 2, '098001133', 'Rbla. México 1450'),
	(10, 3, 'Leandro', 'Santos', '5.432.109-8', 'leandro.santos@drivenow.com', 3, '097112244', 'Av. Rivera 1820'),
	(10, 4, 'Romina', 'Peralta', '4.321.098-7', 'romina.peralta@drivenow.com', 4, '096223355', 'Canelones 1320');

/*DEVUELVE NOMBRE COMPLETO DEL CLIENTE*/
DELIMITER $$
CREATE FUNCTION FN_CLIENTE_APE_NOM(F_EMPRESA INT, F_CLIENTE INT)
RETURNS VARCHAR(200)
DETERMINISTIC
BEGIN
	DECLARE APENOM VARCHAR(200);
	SELECT CONCAT(TRIM(CLI_NOMBRE),' ',TRIM(CLI_APELLIDO)) INTO APENOM
    FROM CLIENTE
    WHERE ID_EMPRESA = F_EMPRESA
    AND ID_CLIENTE = F_CLIENTE;
    RETURN APENOM;
END $$
DELIMITER ;

/*INGRESO DE NUEVO CONTRATO*/
DELIMITER $$
CREATE PROCEDURE SP_INS_CONTRATO(P_EMPRESA INT, P_PRODUCTO INT, P_POLITICA INT, P_CLIENTE INT, P_FCH_CONTRATO DATE, P_FCH_VIGENCIA DATE, P_STS BOOLEAN)
BEGIN
	DECLARE P_ID_CONTRATO INT;
    DECLARE P_ESTADO INT;
    SELECT FN_NEW_ID(P_EMPRESA,'CONTRATO') INTO P_ID_CONTRATO;
    SELECT FN_BUSCAR_ESTADO('CONTRATO',P_STS) INTO P_ESTADO;
    INSERT INTO CONTRATO (ID_EMPRESA,ID_CONTRATO,ID_PRODUCTO,ID_POLITICA,ID_CLIENTE,ID_ESTADO,FCH_CONTRATO,FCH_VIGENCIA,FCH_FIN) 
    VALUES (P_EMPRESA,P_ID_CONTRATO,P_PRODUCTO,P_POLITICA,P_CLIENTE,P_ESTADO,P_FCH_CONTRATO,P_FCH_VIGENCIA,NULL);
END $$
DELIMITER ;

/*TRIGGER PARA MANTENER EL NUMERADOR CON EL MAXIMO VALOR QUE SE INGRESO A LA TABLA (ES PARA EVITAR CONFLICTOS CON INSERTS MANUALES)*/
DELIMITER $$
CREATE TRIGGER TR_UPD_NUM_CONTRATO
AFTER INSERT ON CONTRATO
FOR EACH ROW
BEGIN
	UPDATE NUMERADOR SET ULTIMO_NUM = (SELECT MAX(ID_CONTRATO) FROM CONTRATO WHERE ID_EMPRESA = NEW.ID_EMPRESA)
    WHERE ID_EMPRESA = NEW.ID_EMPRESA 
    AND ENTIDAD = 'CONTRATO';
END $$
DELIMITER ;	

INSERT INTO CONTRATO (ID_EMPRESA, ID_CONTRATO, ID_PRODUCTO, ID_POLITICA,ID_CLIENTE, ID_ESTADO, FCH_CONTRATO, FCH_VIGENCIA, FCH_FIN) VALUES
	-- FitLife Gym
	(1, 1, 1, 1, 1, 5, '2025-01-10', NULL, NULL),
	(1, 2, 2, 2, 2, 6, '2025-01-15', '2025-12-31', NULL), 
	(1, 3, 1, 1, 2, 7, '2024-12-01', NULL, '2025-03-01'), 
	(1, 4, 1, 1, 2, 8, '2024-11-20', NULL, NULL), 
	(1, 5, 2, 2, 3, 6, '2025-03-10', '2025-12-31', NULL), 
	(1, 6, 1, 1, 3, 8, '2024-12-01', NULL, NULL), 
	-- SegurAlarm
	(2, 1, 1, 1, 1, 5, '2025-02-01', NULL, NULL),
	(2, 2, 2, 2, 2, 6, '2025-01-01', '2025-11-30', NULL),
	(2, 3, 2, 2, 2, 7, '2024-10-01', NULL, '2025-02-01'),
	(2, 4, 1, 1, 3, 6, '2025-02-15', '2025-12-31', NULL),
	(2, 5, 1, 1, 3, 8, '2024-12-10', NULL, NULL),
	-- CloudHost Uruguay
	(3, 1, 1, 1, 1, 5, '2025-01-20', NULL, NULL),
	(3, 2, 2, 2, 2, 6, '2025-03-10', '2025-12-31', NULL),
	(3, 3, 1, 1, 2, 7, '2024-12-15', NULL, '2025-04-01'),
	(3, 4, 1, 1, 3, 6, '2025-02-05', '2025-12-31', NULL),
	(3, 5, 1, 1, 3, 8, '2024-10-25', NULL, NULL),
	-- PureWater Delivery
	(4, 1, 1, 1, 1, 5, '2025-02-01', NULL, NULL),
	(4, 2, 2, 2, 2, 6, '2025-01-10', '2025-12-31', NULL),
	(4, 3, 1, 1, 2, 7, '2024-11-01', NULL, '2025-02-10'),
	(4, 4, 2, 2, 3, 6, '2025-03-01', '2025-12-31', NULL),
	(4, 5, 1, 1, 3, 8, '2024-11-20', NULL, NULL),
	-- PetCare Plan
	(5, 1, 1, 1, 1, 5, '2025-02-05', NULL, NULL),
	(5, 2, 2, 2, 2, 6, '2025-03-01', '2026-01-01', NULL),
	(5, 3, 2, 2, 2, 8, '2024-10-15', NULL, NULL),
	(5, 4, 1, 1, 2, 7, '2024-09-01', NULL, '2025-03-10'),
	-- GreenHome Jardinería
	(6, 1, 1, 1, 1, 5, '2025-03-01', NULL, NULL),
	(6, 2, 2, 2, 2, 6, '2025-02-01', '2025-12-31', NULL),
	(6, 3, 1, 1, 2, 7, '2024-11-10', NULL, '2025-03-10'),
	(6, 4, 2, 2, 2, 8, '2024-08-01', NULL, NULL),
	-- SmartEnergy
	(7, 1, 1, 1, 1, 5, '2025-01-05', NULL, NULL),
	(7, 2, 2, 2, 2, 6, '2025-01-15', '2025-12-31', NULL),
	(7, 3, 2, 2, 2, 7, '2024-09-20', NULL, '2025-02-01'),
	(7, 4, 1, 1, 2, 8, '2024-10-15', NULL, NULL),
	-- EduPro E-Learning
	(8, 1, 1, 1, 1, 5, '2025-01-20', NULL, NULL),
	(8, 2, 2, 2, 2, 6, '2025-02-10', '2025-12-31', NULL),
	(8, 3, 1, 1, 2, 7, '2024-11-01', NULL, '2025-03-01'),
	(8, 4, 1, 1, 2, 8, '2024-10-01', NULL, NULL),
	-- CaféClub Suscripciones
	(9, 1, 1, 1, 1, 5, '2025-02-01', NULL, NULL),
	(9, 2, 2, 2, 2, 6, '2025-02-20', '2025-12-31', NULL),
	(9, 3, 2, 2, 2, 7, '2024-12-15', NULL, '2025-03-20'),
	(9, 4, 1, 1, 2, 8, '2024-11-10', NULL, NULL),
	-- DriveNow Rent
	(10, 1, 1, 1, 1, 5, '2025-01-05', NULL, NULL),
	(10, 2, 2, 2, 2, 6, '2025-02-01', '2026-01-15', NULL),
	(10, 3, 1, 1, 2, 7, '2024-11-10', NULL, '2025-03-05'),
	(10, 4, 2, 2, 2, 8, '2024-09-15', NULL, NULL),
	(10, 5, 2, 2, 3, 6, '2025-03-01', '2026-01-01', NULL);

/*DEVUELVE EL TOTAL A FACTURAR A UN CLIENTE*/
DELIMITER $$
CREATE FUNCTION FN_TOTAL_FACTURA(F_EMPRESA INT, F_CLIENTE INT)
RETURNS DECIMAL(10,2)
DETERMINISTIC
BEGIN
	DECLARE FN_TOTAL DECIMAL(10,2);
	DECLARE F_ESTADO INT;
	SELECT FN_BUSCAR_ESTADO('CONTRATO','CONECTADO') INTO F_ESTADO;
	SELECT SUM(P.POL_PRECIO) INTO FN_TOTAL FROM CONTRATO CO
    INNER JOIN POLITICA P
		ON P.ID_EMPRESA = CO.ID_EMPRESA
        AND P.ID_POLITICA = CO.ID_POLITICA
	WHERE CO.ID_EMPRESA = F_EMPRESA
    AND CO.ID_CLIENTE = F_CLIENTE
    AND CO.ID_ESTADO = F_ESTADO
    GROUP BY P.POL_PRECIO;
    RETURN FN_TOTAL;
END $$
DELIMITER ;

/*DEVUELVE LA PROXIMA LINEA A CREAR EN LA FACTURA*/
DELIMITER $$
CREATE FUNCTION FN_NEW_FAC_LIN(F_EMPRESA INT, F_FACTURA INT)
RETURNS INT
DETERMINISTIC
BEGIN
	DECLARE NEW_ID_FACTURALIN INT;
    SELECT FACTURA_ULT_LIN + 1 INTO NEW_ID_FACTURALIN FROM FACTURA WHERE ID_EMPRESA = F_EMPRESA AND ID_FACTURA = F_FACTURA;
    RETURN NEW_ID_FACTURALIN;
END $$
DELIMITER $$

/*INGRESO DE NUEVO FACTURA*/
DELIMITER $$
CREATE PROCEDURE SP_INS_FACTURA(P_EMPRESA INT, P_CLIENTE INT, P_PAGA BOOLEAN, P_FCH DATE, P_FCH_PAGO DATE)
BEGIN
	DECLARE P_ID_FACTURA INT;
    DECLARE P_TOTAL DECIMAL(10,2);
    DECLARE P_ID_FACTURALIN INT;
    DECLARE P_ESTADO INT;
	
    SELECT FN_TOTAL_FACTURA(P_EMPRESA,P_CLIENTE) INTO P_TOTAL;
    SELECT FN_NEW_ID(P_EMPRESA,'FACTURA') INTO P_ID_FACTURA;
    
    /*CREO EL CABEZAL DE LA FACTURA*/
    INSERT INTO FACTURA (ID_EMPRESA,ID_FACTURA,ID_CLIENTE,IS_PAGA,FAC_FCH,FAC_TOTAL,FAC_FCH_PAGO,FACTURA_ULT_LIN) 
    VALUES (P_EMPRESA,P_ID_FACTURA,P_CLIENTE,P_PAGA,P_FCH,P_TOTAL,P_FCH_PAGO,0);
    
    /*CREO LAS LINEAS DE LA FACTURA POR CONTRATO FACTURADO*/
    SELECT FN_BUSCAR_ESTADO('CONTRATO','CONECTADO') INTO P_ESTADO;
    INSERT INTO FACTURALINEA 
    SELECT CO.ID_EMPRESA,P_ID_FACTURA,FN_NEW_FAC_LIN(CO.ID_EMPRESA,P_ID_FACTURA),CO.ID_CONTRATO,P.POL_PRECIO
    FROM CONTRATO CO
    INNER JOIN POLITICA P
		ON P.ID_EMPRESA = CO.ID_EMPRESA
        AND P.ID_POLITICA = CO.ID_POLITICA
	WHERE CO.ID_EMPRESA = P_EMPRESA
    AND CO.ID_CLIENTE = P_CLIENTE
    AND CO.ID_ESTADO = P_ESTADO;
END $$
DELIMITER ;

/*TRIGGER PARA MANTENER EL NUMERADOR CON EL MAXIMO VALOR QUE SE INGRESO A LA TABLA (ES PARA EVITAR CONFLICTOS CON INSERTS MANUALES)*/
DELIMITER $$
CREATE TRIGGER TR_UPD_NUM_FACTURA
AFTER INSERT ON FACTURA
FOR EACH ROW
BEGIN
	UPDATE NUMERADOR SET ULTIMO_NUM = (SELECT MAX(ID_FACTURA) FROM FACTURA WHERE ID_EMPRESA = NEW.ID_EMPRESA)
    WHERE ID_EMPRESA = NEW.ID_EMPRESA 
    AND ENTIDAD = 'FACTURA';
END $$
DELIMITER ;	

/*TRIGGER PARA ACTUALIZAR EL CAMPO DE LA TABLA FACTURA QUE GUARDA LA ULTIMA LINEA CREADA (SERIA COMO UN NUMERADOR PERO PARA CADA FACTURA)*/
DELIMITER $$
CREATE TRIGGER TR_UPD_FACTURA_ULT_LIN
AFTER INSERT ON FACTURALINEA
FOR EACH ROW
BEGIN
	UPDATE FACTURA SET FACTURA_ULT_LIN = (SELECT MAX(ID_FACTURALIN) FROM FACTURALINEA WHERE ID_EMPRESA = NEW.ID_EMPRESA AND ID_FACTURA = NEW.ID_FACTURA);
END $$
DELIMITER ;

/*INGRESO DE DATOS DE FACTURA Y FACTURALINEA*/
INSERT INTO FACTURA (ID_EMPRESA, ID_FACTURA, ID_CLIENTE, IS_PAGA, FAC_FCH, FAC_TOTAL) VALUES
	-- FitLife Gym S.R.L.
    (1, 1, 1, 0, '2025-11-01', 1800.00),
	(1, 2, 2, 0, '2025-11-01', 3200.00),
	(1, 3, 3, 0, '2025-11-01', 3200.00),
    -- SegurAlarm S.A.
	(2, 1, 1, 0, '2025-11-01', 1500.00),
	(2, 2, 2, 0, '2025-11-01', 2700.00),
	(2, 3, 3, 0, '2025-11-01', 2700.00),
    -- CloudHost Uruguay S.R.L.
	(3, 1, 1, 0, '2025-11-01', 800.00),
	(3, 2, 2, 0, '2025-11-01', 1600.00),
	(3, 3, 3, 0, '2025-11-01', 1600.00),
    -- PureWater Delivery S.A.
	(4, 1, 1, 0, '2025-11-01', 600.00),
	(4, 2, 2, 0, '2025-11-01', 1100.00),
	(4, 3, 3, 0, '2025-11-01', 1100.00),
    -- PetCare Plan S.R.L.
	(5, 1, 1, 0, '2025-11-01', 1200.00),
	(5, 2, 2, 0, '2025-11-01', 2100.00),
    -- GreenHome Jardinería S.A.
	(6, 1, 1, 0, '2025-11-01', 1000.00),
	(6, 2, 2, 0, '2025-11-01', 1800.00),
    -- SmartEnergy S.R.L.
	(7, 1, 1, 0, '2025-11-01', 900.00),
	(7, 2, 2, 0, '2025-11-01', 1600.00),
    -- EduPro E-Learning S.A.
	(8, 1, 1, 0, '2025-11-01', 750.00),
	(8, 2, 2, 0, '2025-11-01', 2800.00),
    -- CaféClub Suscripciones S.R.L.
	(9, 1, 1, 0, '2025-11-01', 650.00),
	(9, 2, 2, 0, '2025-11-01', 1150.00),
	(10, 1, 1, 0, '2025-11-01', 12000.00),
    -- DriveNow Rent S.A.
	(10, 2, 2, 0, '2025-11-01', 18500.00),
	(10, 3, 3, 0, '2025-11-01', 18500.00);

INSERT INTO FACTURALINEA (ID_EMPRESA, ID_FACTURA, ID_FACTURALIN, ID_CONTRATO, FAC_LIN_IMP) VALUES
	-- FitLife Gym S.R.L.
    (1, 1, 1, 1, 1800.00),
	(1, 2, 1, 2, 3200.00),
	(1, 3, 1, 5, 3200.00),
    -- SegurAlarm S.A.
	(2, 1, 1, 1, 1500.00),
	(2, 2, 1, 2, 2700.00),
	(2, 3, 1, 4, 2700.00),
    -- CloudHost Uruguay S.R.L.
	(3, 1, 1, 1, 800.00),
	(3, 2, 1, 2, 1600.00),
	(3, 3, 1, 3, 1600.00),
    -- PureWater Delivery S.A.
	(4, 1, 1, 1, 600.00),
	(4, 2, 1, 2, 1100.00),
	(4, 3, 1, 3, 1100.00),
    -- PetCare Plan S.R.L.
	(5, 1, 1, 1, 1200.00),
	(5, 2, 1, 2, 2100.00),
    -- GreenHome Jardinería S.A.
	(6, 1, 1, 1, 1000.00),
	(6, 2, 1, 2, 1800.00),
    -- SmartEnergy S.R.L.
	(7, 1, 1, 1, 900.00),
	(7, 2, 1, 2, 1600.00),
    -- EduPro E-Learning S.A.
	(8, 1, 1, 1, 750.00),
	(8, 2, 1, 2, 2800.00),
    -- CaféClub Suscripciones S.R.L.
	(9, 1, 1, 1, 650.00),
	(9, 2, 1, 2, 1150.00),
    -- DriveNow Rent S.A.
	(10, 1, 1, 1, 12000.00),
	(10, 2, 1, 2, 18500.00),
	(10, 3, 1, 4, 18500.00);

/*TRIGGER PARA MANTENER EL NUMERADOR CON EL MAXIMO VALOR QUE SE INGRESO A LA TABLA (ES PARA EVITAR CONFLICTOS CON INSERTS MANUALES)*/
DELIMITER $$
CREATE TRIGGER TR_UPD_NUM_ORDENSERVICIO
AFTER INSERT ON ORDENSERVICIO
FOR EACH ROW
BEGIN
	UPDATE NUMERADOR SET ULTIMO_NUM = (SELECT MAX(ID_ORDEN) FROM ORDENSERVICIO WHERE ID_EMPRESA = NEW.ID_EMPRESA)
    WHERE ID_EMPRESA = NEW.ID_EMPRESA 
    AND ENTIDAD = 'ORDENSERVICIO';
END $$
DELIMITER ;	

/*INSERT DE ORDENES EN RELACION A LOS CONTRATOS DE LOS CLIENTES*/
INSERT INTO ORDENSERVICIO (ID_EMPRESA, ID_ORDEN, ID_CONTRATO, ID_ORDENTPO, ORD_FCH, ORD_FCH_FIN, ID_ESTADO) VALUES
	-- FitLife Gym S.R.L.
	(1, 1, 1, 'I', '2024-10-20', '2024-10-25', 10),
	(1, 2, 2, 'I', '2025-11-01', NULL, 9),
	(1, 3, 3, 'I', '2024-09-12', '2024-09-15', 10),
	(1, 4, 3, 'D', '2024-09-20', '2024-09-22', 10),
	(1, 5, 4, 'I', '2024-08-15', '2024-08-20', 11),
	-- SegurAlarm S.A.
	(2, 1, 1, 'I', '2024-11-02', '2024-11-08', 10),
	(2, 2, 2, 'I', '2025-10-15', NULL, 9),
	(2, 3, 3, 'I', '2024-09-25', '2024-09-30', 10),
	(2, 4, 3, 'D', '2024-10-02', '2024-10-05', 10),
	(2, 5, 4, 'I', '2024-08-20', '2024-08-25', 11),
	-- CloudHost Uruguay S.R.L.
	(3, 1, 1, 'I', '2024-10-30', '2024-11-02', 10),
	(3, 2, 2, 'I', '2025-10-20', NULL, 9),
	(3, 3, 3, 'I', '2024-09-18', '2024-09-22', 10),
	(3, 4, 3, 'D', '2024-09-27', '2024-09-30', 10),
	(3, 5, 4, 'I', '2024-08-12', '2024-08-15', 11),
	-- PureWater Delivery S.A.
	(4, 1, 1, 'I', '2024-11-05', '2024-11-09', 10),
	(4, 2, 2, 'I', '2025-11-02', NULL, 9),
	(4, 3, 3, 'I', '2024-09-25', '2024-09-28', 10),
	(4, 4, 3, 'D', '2024-10-01', '2024-10-03', 10),
	(4, 5, 4, 'I', '2024-08-10', '2024-08-13', 11),
	-- PetCare Plan S.R.L.
	(5, 1, 1, 'I', '2024-10-22', '2024-10-27', 10),
	(5, 2, 2, 'I', '2025-10-08', NULL, 9),
	(5, 3, 3, 'I', '2024-09-18', '2024-09-22', 10),
	(5, 4, 3, 'D', '2024-09-28', '2024-09-30', 10),
	(5, 5, 4, 'I', '2024-08-10', '2024-08-12', 11),
	-- GreenHome Jardinería S.A.
	(6, 1, 1, 'I', '2024-11-03', '2024-11-07', 10),
	(6, 2, 2, 'I', '2025-10-18', NULL, 9),
	(6, 3, 3, 'I', '2024-09-15', '2024-09-20', 10),
	(6, 4, 3, 'D', '2024-09-25', '2024-09-27', 10),
	(6, 5, 4, 'I', '2024-08-05', '2024-08-08', 11),
	-- SmartEnergy S.R.L.
	(7, 1, 1, 'I', '2024-11-01', '2024-11-05', 10),
	(7, 2, 2, 'I', '2025-11-02', NULL, 9),
	(7, 3, 3, 'I', '2024-09-10', '2024-09-14', 10),
	(7, 4, 3, 'D', '2024-09-20', '2024-09-22', 10),
	(7, 5, 4, 'I', '2024-08-01', '2024-08-04', 11),
	-- EduPro E-Learning S.A.
	(8, 1, 1, 'I', '2024-10-28', '2024-11-02', 10),
	(8, 2, 2, 'I', '2025-10-12', NULL, 9),
	(8, 3, 3, 'I', '2024-09-12', '2024-09-17', 10),
	(8, 4, 3, 'D', '2024-09-23', '2024-09-26', 10),
	(8, 5, 4, 'I', '2024-08-06', '2024-08-09', 11),
	-- CaféClub Suscripciones S.R.L.
	(9, 1, 1, 'I', '2024-11-05', '2024-11-10', 10),
	(9, 2, 2, 'I', '2025-09-20', NULL, 9),
	(9, 3, 3, 'I', '2024-09-18', '2024-09-22', 10),
	(9, 4, 3, 'D', '2024-09-27', '2024-09-30', 10),
	(9, 5, 4, 'I', '2024-08-12', '2024-08-15', 11),
	-- DriveNow Rent S.A.
	(10, 1, 1, 'I', '2024-10-25', '2024-10-30', 10),
	(10, 2, 2, 'I', '2025-11-02', NULL, 9),
	(10, 3, 3, 'I', '2024-09-20', '2024-09-25', 10),
	(10, 4, 3, 'D', '2024-09-28', '2024-09-30', 10),
	(10, 5, 4, 'I', '2024-08-08', '2024-08-12', 11);
    
/*VIEW PARA VER LOS PRODUCTOS CONTRATADOS DE CADA CLIENTE A DETALLE*/
CREATE VIEW VW_SERVICIOS_GENERADOS AS
SELECT E.EMP_NOMBRE AS 'EMPRESA', 
FN_CLIENTE_APE_NOM(CO.ID_EMPRESA,CO.ID_CLIENTE) AS 'CLIENTE',
CO.ID_CONTRATO AS 'CONTRATO',
S.DESCRIPCION AS 'ESTADO',
P.PRD_NOMBRE AS 'PRODUCTO', 
PL.POL_NOMBRE AS 'POLITICA', PL.POL_PRECIO AS 'PRECIO',
CO.FCH_CONTRATO AS 'FECHA INGRESO',
CO.FCH_VIGENCIA AS 'FECHA VIGENCIA',
CO.FCH_FIN AS 'FECHA DESCONEXION'
FROM CONTRATO CO
INNER JOIN EMPRESA E
	ON E.ID_EMPRESA = CO.ID_EMPRESA
INNER JOIN CLIENTE C
	ON C.ID_EMPRESA = CO.ID_EMPRESA
    AND C.ID_CLIENTE = CO.ID_CLIENTE
INNER JOIN PRODUCTO P
	ON P.ID_EMPRESA = CO.ID_EMPRESA
    AND P.ID_PRODUCTO = CO.ID_PRODUCTO
INNER JOIN POLITICA PL
	ON PL.ID_EMPRESA = CO.ID_EMPRESA
    AND PL.ID_POLITICA = CO.ID_POLITICA
INNER JOIN ESTADO S
	ON S.ID_ESTADO = CO.ID_ESTADO
ORDER BY CO.ID_EMPRESA, CO.ID_CLIENTE, CO.ID_CONTRATO;

/*VIEW PARA VER LA CONFIGURACION DE PRODUCTOS QUE SE OFRECEN POR EMPRESA*/
CREATE VIEW VW_PRD_CONFIG_ACTIVOS AS 
SELECT E.EMP_NOMBRE AS 'EMPRESA', 
P.PRD_NOMBRE AS 'PRODUCTO',
PL.POL_NOMBRE AS 'POLITICA'
FROM PRODUCTOPOL PP
INNER JOIN EMPRESA E
	ON E.ID_EMPRESA = PP.ID_EMPRESA
INNER JOIN PRODUCTO P
	ON P.ID_EMPRESA = PP.ID_EMPRESA
    AND P.ID_PRODUCTO = PP.ID_PRODUCTO
INNER JOIN POLITICA PL
	ON PL.ID_EMPRESA = PP.ID_EMPRESA
    AND PL.ID_POLITICA = PL.ID_POLITICA
WHERE P.IS_ACTIVO = 1
AND PL.IS_ACTIVO = 1
ORDER BY PP.ID_EMPRESA, PP.ID_PRODUCTO, PP.ID_POLITICA;

CREATE VIEW VW_FACTURAS_DETALLES AS
SELECT E.EMP_NOMBRE AS 'EMPRESA',
F.ID_CLIENTE, FN_CLIENTE_APE_NOM(F.ID_EMPRESA,F.ID_CLIENTE) AS 'CLIENTE',
F.ID_FACTURA AS 'FACTURA', FL.ID_FACTURALIN AS 'LINEA',
P.PRD_NOMBRE AS 'PRODUCTO',
PL.POL_NOMBRE AS 'POLITICA',
FL.FAC_LIN_IMP AS 'IMPORTE'
FROM FACTURA F
INNER JOIN EMPRESA E
	ON E.ID_EMPRESA = F.ID_EMPRESA
INNER JOIN CLIENTE C
	ON C.ID_EMPRESA = F.ID_EMPRESA
    AND C.ID_CLIENTE = F.ID_CLIENTE
INNER JOIN FACTURALINEA FL
	ON FL.ID_EMPRESA = F.ID_EMPRESA
    AND FL.ID_FACTURA = F.ID_FACTURA
INNER JOIN CONTRATO CO
	ON CO.ID_EMPRESA = F.ID_EMPRESA
    AND CO.ID_CONTRATO = FL.ID_CONTRATO
INNER JOIN PRODUCTO P
	ON P.ID_EMPRESA = F.ID_EMPRESA
    AND P.ID_PRODUCTO = CO.ID_PRODUCTO
INNER JOIN POLITICA PL
	ON PL.ID_EMPRESA = F.ID_EMPRESA
    AND PL.ID_POLITICA = CO.ID_POLITICA
ORDER BY F.ID_EMPRESA, F.ID_CLIENTE, F.ID_FACTURA, FL.ID_FACTURALIN;

/*PROCESO PARA SEGUIMIENTO DE ORDENES INCUMPLIDAS. DEVUELVE LAS ORDENES CUYO RETRASO ES DE X DIAS A LA FECHA DE HOY*/
DELIMITER $$
CREATE PROCEDURE SP_ORDENES_ATRASADAS(P_EMPRESA INT, P_CNT_DIAS INT)
BEGIN
	SELECT *, DATEDIFF(CURDATE(),ORD_FCH) AS 'DIAS ATRASADOS' FROM ORDENSERVICIO
	WHERE ID_EMPRESA = P_EMPRESA
	AND ORD_FCH_FIN IS NULL
	AND DATEDIFF(CURDATE(),ORD_FCH) >= P_CNT_DIAS;
END $$
DELIMITER ;  






